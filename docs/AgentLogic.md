# Agent Logic

* [Open Issues](#open-issues)
* [Criteria](#Criteria)

The main agent logic is the following loop

* [Action Selection](#action-selection)

1. Calculate a score bias
2. Calculate a score for each action/behavior
3. Select one action
4. Test if the action can be performed
5. Execute the action or execute Break instead

* [Handle Interactions](#handle-interactions)

* [Update Happiness](#update-happiness)
* [Update Attention](#update-attention)


In Addition there are the following mechanics
* [Behavior Score](#behavior-score)
* [Behavior Happiness and Motivation Updates](#Behavior-hm-updates)
* [Classroom noise](#classroom-noise)

# Open Issues

* Agents behavior distribution is not following expected personality types
* Agents are taking too many breaks

# Criteria
What are criteria on which to evaluate the *goodness* of the simulation?

* The internal and aggregated values (Motivation, Happiness, Attention, Noise) should express a dynamic behavior.
* Agent Action distribution should be diverse, but follow basic expectations about how 'extraversion' and 'conscientiousness' effects the action chooser.
* There should be some variance between instances of the same Personality Configuration executing with different seeds.
* There should be a systematic shift between drastically different Personality Configurations.

# Action Selection
The basic action sequence one would expect is to alternate between Stuyding (Study Alone or Study in Group) and Resting (Taking a break or Chatting) actions. Only if the agent is prevented from following that cycle, experiences a drop
in Happiness that if sufficiently strong would cause the agent to start to quarrel with another agent.

## Score Bias
The score bias is added to the current action, and substracted from the previous action
in order to prevent the agent from switching constantly between actions, and keep it onto the current action.

The function is an exponential falling decay, parameterized by the the conscientousness of
the agent. See a [plot here](https://www.wolframalpha.com/input/?i=plot+10.0+*+e**(-(1.0-0.3)*x)+from+x%3D0+to+5)

The intention is that over time (ticks) the bias is reduced, and that an agent with high conscientousness keeps a higher bias for a longer time. Therefore prolonging staying on the same task/action.

```C#
ACTION_SCORE_BIAS = 10.0

score_bias = (int)(ACTION_SCORE_BIAS * Math.Exp(-(1.0 - personality.conscientousness) * (float)ticksOnThisTask));
```

## Probabilistic Action Selection
Actions are selected on a probabilistic bases, giving actions with a higher score a higher chance to be selected - Similar to the score bias. This is done by squaring the scores before normalizing each score and calculating its corresponding probability,

<p align="center">
    <img src="/docs/images/score_squared.png" alt="Probability_calculation" width="400"/>
</p

# Handle Interactions
Interactive actions are **Chat** and **Quarrel**.
In both cases if an agent decides to execute that action, it selects randomly another agent in the classroom and sends a 'request' for that action.

The other agent will decide in its next turn if to accept or reject the request.

If the request is rejected the sending agent will try again fro two more times, before switching to another agent and will continue there.

The receiving agent is deciding to accept or reject the request depending on its personality and a random factor.
The receiving agent will generate a random number between [0, 1]
* for **Chat**: If that random number > agent.conscioentousness, accept the request, if not, reject
* for **Quarrel**: If that random number > receiving_agent.agreeableness, accept the request, if not, reject. 


## Update Happiness
At the moment Happiness should increase if the agent is performing its desired action, and decrease otherwise. Agents high on neuroticism should experience a stronger decline in happiness.
Dont touch happiness in case the agent is executing Quarrel.

```C#
HAPPINESS_INCREASE = 0.05;
HAPPINESS_DECREASE = 0.05;

if (currentAction is Quarrel)
    return;

if(currentAction == Desire)
    change = HAPPINESS_INCREASE;
else
    change = -HAPPINESS_DECREASE * (1.0 - personality.neuroticism);

happiness = AgentBehavior.boundValue(0.0, happiness + change, 1.0);
```


## Update Attention
The attention is a positive value in case the agent is studying.
If so, it is a value between [0, 1], that increases with consciousness and motivation, and reduced by noise in the classroom.

Noise is generated by each behavior (with quarrel generating the most, and study alone the least).

```C#
if((currentAction is StudyAlone) || (currentAction is StudyGroup))
{
    if (currentAction.state == AgentBehavior.ActionState.EXECUTING)
    {
        attention = AgentBehavior.boundValue(0.0, personality.conscientousness + motivation - classroom.noise, 1.0);
    }
} else {
    attention = 0.0;
}
```



# Behavior Score

Each Behavior/Action has a rate method that returns a score for that particular agent and behavior.

The rates are calculated based on two functions, following an exponential growth or decay, normalized
from y = [0, 1] between x = [0, 1]. All scores are cutoff between [0, 1].

They are plotted at

* [ExpDecay(x)](https://www.wolframalpha.com/input/?i=plot+(exp((1-x)**2)-1)%2F(e-1)+from+x%3D0+to+1)
<p align="center">
    <img src="/docs/images/exp_decay.png" alt="Exp decay" width="400"/>
</p

* [ExpGrowth(x)](https://www.wolframalpha.com/input/?i=(exp(x**2)+-+1)++%2F+(exp(1)+-+1)for+x+%3D+0++to+1)
<p align="center">
    <img src="/docs/images/exp_growth.png" alt="Exp growth" width="400"/>
</p

Each score depends on three aspects
* Personality
* Motivation
* Happiness

A single function is used to calculate the score for each Behavior, but each Behavior defines the parameters to that function.

The function is basically calculating a weighted sum of those three components.

```C#
// Normalize the weights
double sum = personlity_weight + motivation_weight + happiness_weight;

double weighted = (personality_term * personlity_weight/sum) + (motivation_term * motivation_weight/sum) + (happiness_term * happiness_weight/sum);
double score = boundValue(0.0, weighted, 1.0);
```

## Chat
The score depends on extraversion and motivation, and it should be high if the agent is high on extraversion and low on motivation.

```C#
double score = CalculateScore(agent.personality.extraversion, 0.33, ExpDecay(agent.motivation), 0.33, ExpGrowth(agent.happiness), 0.33);
```

## Take a Break
Taking a break is equal to 'Chat' for introverts.

```C#
double score = CalculateScore(1.0 - agent.personality.extraversion, 0.33, ExpDecay(agent.motivation), 0.33, ExpGrowth(agent.happiness), 0.33);
```

## Study Alone
This is the counterpart to taking a break. If the agent is motivated enough and an introvert
she should get a higher score.

```C#
double score = CalculateScore(1.0 - agent.personality.extraversion, 0.33, ExpGrowth(agent.motivation), 0.33, ExpGrowth(agent.happiness), 0.33);
```

## Study Group
The pervered way to study for extaverts. Should get a high score for motivated agents high on extraversion.

```C#
double score = CalculateScore(agent.personality.extraversion, 0.33, ExpGrowth(agent.motivation), 0.33, ExpGrowth(agent.happiness), 0.33);
```

## Quarrel/Argue
This is the only behavior that has a slightly different formular, because it should
get a high score when the agent is unhappy and is motivated.

```C#
double score = CalculateScore(agent.personality.agreeableness, 0.25, ExpGrowth(agent.motivation), 0.25, ExpDecay(agent.happiness, power: 4), 0.5);
```

**Note**: Happiness is following a Exponential decay to the 4 power! Causing a stronger decrease of this component.


# Behavior HM updates
During execution of a behavior the agents Happiness and Motivation is adjusted.

The Behaviors (Chat, Study in Group and Quarrel) share the same function to calculate
the effect on the agent stats while the agent is waiting to perform the action ...

```C#
HAPPINESS_INCREASE = -0.0;
MOTIVATION_INCREASE = -0.02;
NEUROTICISM_WEIGHT = 1.0;
AGREEABLENESS_WEIGHT = 0.5;

intensity = boundValue(0.0, agent.personality.neuroticism * NEUROTICISM_WEIGHT - agent.personality.agreeableness * AGREEABLENESS_WEIGHT, 1.0);
happiness = boundValue(-1.0, agent.happiness + intensity * HAPPINESS_INCREASE, 1.0);
motivation = boundValue(0.0, agent.motivation + MOTIVATION_INCREASE, 1.0);
```

The others are as follows ...

* Take a Break: 
```C#
HAPPINESS_INCREASE = 0.00;
MOTIVATION_INCREASE = 0.05;

agent.motivation = boundValue(0.0, agent.motivation + MOTIVATION_INCREASE, 1.0);
agent.happiness = boundValue(0.0, agent.happiness + HAPPINESS_INCREASE, 1.0);
```

* Chat:

While Waiting: Function above

While Chatting:
```C#
HAPPINESS_INCREASE = 0.00;
MOTIVATION_INCREASE = 0.05;

agent.motivation = boundValue(0.0, agent.motivation + MOTIVATION_INCREASE, 1.0);
agent.happiness = boundValue(0.0, agent.happiness + HAPPINESS_INCREASE, 1.0);
```
* Study Alone:

While executing:
```C#
MOTIVATION_INCREASE = -0.05;
HAPPINESS_INCREASE = 0.00;

agent.motivation = boundValue(0.0, agent.motivation + MOTIVATION_INCREASE, 1.0);
agent.happiness = boundValue(0.0, agent.happiness + HAPPINESS_INCREASE, 1.0);
```

* Study in Group:
While Waiting: Function above

While Executing:
```C#
HAPPINESS_INCREASE = 0.00;
MOTIVATION_INCREASE = -0.05;

agent.motivation = boundValue(0.0, agent.motivation + MOTIVATION_INCREASE, 1.0);
agent.happiness = boundValue(0.0, agent.happiness + HAPPINESS_INCREASE, 1.0);
```

* Quarrel:
While Waiting: Function above

While Executing:
```C#
HAPPINESS_INCREASE = -0.20;
MOTIVATION_INCREASE = -0.20;

agent.motivation = boundValue(0.0, agent.motivation + MOTIVATION_INCREASE, 1.0);
agent.happiness = boundValue(0.0, agent.happiness + HAPPINESS_INCREASE, 1.0);
```

# Classroom noise
The classroom noise is an environment effect that is defined by the behavior executing by each agent.
The noise is simply added for each agent. The behaviors generate the following noise increments.

* Chat: 0.1
* Take a break: 0.05
* Study alone: 0.05
* Study in group: 0.05
* Quarrel: 0.2

The noise level is effecting agents while studying. Studying for an agent is not possible
if the noise level goes beyond some threshold.

* Study Alone:

```C#
NOISE_SCALE = 2.0


if(agent.classroom.noise >= agent.personality.conscientousness * NOISE_SCALE)
    // CANNOT STUDY
```

* Study in Group:
**NOTE**: No limit for group studies at the moment